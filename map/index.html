<!DOCTYPE html>
<html>
   <head>
      <title>Leaflet sample</title>
      <link rel = "stylesheet" href = "http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
      <script src = "http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
      <script src = "rotatedMarker.js"></script>
   </head>
   
   <body>
      <div id = "map" style = "width:1200px; height:800px"></div>
      <script>
	// Converts from degrees to radians.
        function toRadians(degrees) {
          return degrees * Math.PI / 180;
        };
 
        // Converts from radians to degrees.
        function toDegrees(radians) {
          return radians * 180 / Math.PI;
        }


        function bearing(startLat, startLng, destLat, destLng){
          startLat = toRadians(startLat);
          startLng = toRadians(startLng);
          destLat = toRadians(destLat);
          destLng = toRadians(destLng);

          y = Math.sin(destLng - startLng) * Math.cos(destLat);
          x = Math.cos(startLat) * Math.sin(destLat) -
                    Math.sin(startLat) * Math.cos(destLat) * Math.cos(destLng - startLng);
          brng = Math.atan2(y, x);
          brng = toDegrees(brng);
          return (brng + 360) % 360;
        }

        const url = 'https://2o91lyf8y0.execute-api.us-east-1.amazonaws.com/Prod/taxi/';
	let taxis = [];

        getTaxis = (url, map, L, layerGroup, taxiIcon) => {
         fetch(url, { 
           method: 'GET'
         })
         .then(function(response) { return response.json(); })
         .then(function(json) {

           // use the json
           json.forEach(taxi => {
             const coords = taxi.location.coordinates;
	     let taxi_obj = taxis.find(t => t._id === taxi._id);
	     if (taxi_obj === undefined) {
	       taxi_obj = {...taxi, lat: coords[1], lng: coords[0], angle: 0};
	       taxis.push(taxi_obj);
	     } else {
		taxi_obj.angle = bearing(taxi_obj.lat, taxi_obj.lng, coords[1], coords[0]);
	     }
           });
	   // Clear all markers and add new markers based on the updated taxi list.
           layerGroup.clearLayers();
	   taxis.forEach(taxi_obj => {
	     const marker = L.rotatedMarker([taxi_obj.lat, taxi_obj.lng], {icon: taxiIcon});
	     marker.setRotationAngle(taxi_obj.angle);
	     marker.addTo(layerGroup);
           });
         });
        };

         // Marker Icon definition
         var taxiIcon = L.icon({
             iconUrl: 'taxi.png',
             iconSize:     [30, 40], // size of the icon
             iconAnchor:   [15, 20] // point of the icon which will correspond to marker's location
         });

         // Creating map options
         var mapOptions = {
            center: [13.0, 77.6],
            zoom: 11
         }
         // Creating a map object
         var map = new L.map('map', mapOptions);
         
         // Creating a Layer object
         var layer = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
         
         // Adding layer to the map
         map.addLayer(layer);

         const layerGroup = L.layerGroup().addTo(map);

         let id = setInterval('getTaxis(url, map, L, layerGroup, taxiIcon);', 5000); //call getTaxis every 5 seconds.
         function stop() { // call this to stop your interval.
         clearInterval(id);
         }

         

      </script>
   </body>
   
</html>
